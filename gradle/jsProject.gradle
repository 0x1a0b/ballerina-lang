import org.apache.tools.ant.taskdefs.condition.Os
apply plugin: 'base'

task npmInstall(type: Exec) {
    inputs.file("package-lock.json")
    outputs.dir("node_modules")
    doFirst {
        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
            commandLine 'cmd', '/c', 'npm', 'install'
        } else {
            commandLine 'npm', 'install'
        }
    }
}

task npmBuild(type: Exec) {
    mustRunAfter 'npmInstall'
    doFirst {
        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
            commandLine 'cmd', '/c', 'npm', 'run', 'build'
        } else {
            commandLine 'npm', 'run', 'build'
        }
    }
}

assemble {
    dependsOn npmInstall
    dependsOn npmBuild
}

task test(type: Exec) {
    onlyIf {
        !assemble.state.upToDate
    }
    doFirst {
        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
            commandLine 'cmd', '/c', 'npm', 'test'
        } else {
            commandLine 'npm', 'test'
        }
    }
}

// build.finalizedBy 'test'